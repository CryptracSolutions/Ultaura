# Insights Without Transcripts - Part 2: Dashboard and Notifications

## Scope
- Insights dashboard UI, including line selector, summary cards, charts, and call history enhancements.
- Line settings integration for insights/privacy and weekly summaries.
- Weekly summary generation, email templates, and missed-call alert delivery.
- Notification preferences, server actions, and Next.js API endpoints for email delivery.
- Scheduled jobs for weekly summaries and missed-call alert checks.

## Non-Goals
- Telephony insights extraction, Grok tools, and baseline recalculation (Part 1).
- SMS delivery in MVP (email only).
- Storing transcripts, quotes, or paraphrased summaries; or tracking conversation clarity/confusion.

## Dependencies
- Depends on Part 1 for insights capture, baselines, privacy state, call-session counters, and encryption helpers.
- Email delivery infrastructure (Nodemailer) and billing_email field are available.

## Implementation Order (Part 2)
1. Phase 2: Dashboard UI
   - Create /insights route and client components.
   - Build InsightsDashboard layout and data fetching actions.
   - Implement topic, concern, mood, engagement, and call activity displays.
   - Add insights and privacy controls to line settings.
2. Phase 3: Notifications
   - Create notification preferences table and UI.
   - Implement weekly summary generation and storage.
   - Build weekly summary and missed-call alert email templates.
   - Implement missed-call alert logic.
   - Add Next.js API routes for weekly summaries and missed-call alerts.
3. Phase 4 (UI): Privacy and Pause
   - Implement privacy filtering in UI.
   - Add pause mode toggle to settings.
4. Phase 5: Polish and Testing
   - Add loading states and error handling.
   - Test alerting thresholds.
   - QA weekly summary emails.
   - Verify mobile dashboard responsiveness.

## File Changes Summary (Part 2)

### New Files
- /telephony/src/services/weekly-summary.ts
- /telephony/src/scheduler/weekly-summary-scheduler.ts
- /src/lib/emails/weekly-summary.tsx
- /src/lib/emails/missed-calls-alert.tsx
- /src/app/api/telephony/weekly-summary/route.ts
- /src/app/api/telephony/missed-calls/route.ts
- /src/lib/ultaura/insights.ts
- /src/app/dashboard/(app)/insights/page.tsx
- /src/app/dashboard/(app)/insights/InsightsPageClient.tsx
- /src/app/dashboard/(app)/insights/components/*.tsx

### Modified Files
- /src/app/dashboard/(app)/lines/[lineId]/settings/SettingsClient.tsx
- /src/app/dashboard/(app)/lines/components/AddLineModal.tsx
- /src/app/dashboard/(app)/lines/[lineId]/components/CallActivityList.tsx
- /src/navigation.config.tsx
- /src/lib/ultaura/types.ts
- /src/lib/ultaura/constants.ts

## Weekly Summary

### Delivery

**Default format**: Email only (SMS not implemented in MVP)
**Default timing**: Sunday evening (user's timezone)
**Content**: Self-contained (no login required for basic info)

**Note**: While the database schema supports `weekly_summary_format` values of 'email', 'sms', or 'both', the MVP implementation ignores SMS (even if selected) and only sends email. Add a TODO comment in notification sending logic for future SMS support.

### Email Template Structure

```
Subject: Weekly Check-in Summary for [Senior Name]

---
ULTAURA WEEKLY INSIGHTS
Week of [Date Range]
---

[If paused:]
PAUSE NOTE
- Calls are currently paused for this line.

CALL ACTIVITY
- Calls answered: X/Y scheduled (show +/- answered calls vs last week when available)
- Average duration: Xm (trend)
- Missed calls: X (only if answer_rate drop >=20pp vs baseline and missed >=2)

ENGAGEMENT
- [Only if changed] "Engagement has been lower than typical"

MOOD PATTERN
- [Summary of week's mood trend]
- Example: "Mostly neutral with some low moments mid-week" or "Mixed week"

Mood summary logic:
- "Mixed week" if the week includes both positive and low calls

TOPICS DISCUSSED
- [Top 5 topic tags as chips/list]

[If any concerns detected:]
WELLBEING NOTES
- [New/Recurring/Resolved concerns with severity]

[If needs_follow_up true:]
FOLLOW-UP SUGGESTED
- Based on this week's patterns, consider checking in about: [reason codes]

---
[Footer disclaimer]
These insights are generated by AI and are not medical or clinical advice.
For emergencies, contact local emergency services.

Manage notification preferences: [link to dashboard settings]
---
```

### SMS Format (future, not implemented in MVP)

```
Ultaura Weekly: [Name]
Calls: 5/6 answered
Mood: mostly positive
New concern: sleep (mild)
View details: [dashboard link]
```

## Database Schema (Part 2)

### New Table: `ultaura_weekly_summaries`

```sql
CREATE TABLE ultaura_weekly_summaries (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  line_id UUID NOT NULL REFERENCES ultaura_lines(id) ON DELETE CASCADE,
  account_id UUID NOT NULL REFERENCES ultaura_accounts(id) ON DELETE CASCADE,
  week_start_date DATE NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),

  -- Aggregated data (encrypted)
  summary_ciphertext BYTEA NOT NULL,
  summary_iv BYTEA NOT NULL,
  summary_tag BYTEA NOT NULL,
  summary_alg TEXT NOT NULL DEFAULT 'aes-256-gcm',
  summary_kid TEXT NOT NULL DEFAULT 'kek_v1',  -- KEK version string (matches memories pattern)

  -- Delivery tracking
  email_sent_at TIMESTAMPTZ,
  sms_sent_at TIMESTAMPTZ,

  UNIQUE(line_id, week_start_date)
);

CREATE INDEX idx_summaries_line_week ON ultaura_weekly_summaries(line_id, week_start_date DESC);
```

### New Table: `ultaura_notification_preferences`

```sql
CREATE TABLE ultaura_notification_preferences (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  account_id UUID NOT NULL REFERENCES ultaura_accounts(id) ON DELETE CASCADE,
  line_id UUID NOT NULL REFERENCES ultaura_lines(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),

  -- Weekly summary preferences
  weekly_summary_enabled BOOLEAN NOT NULL DEFAULT true,
  weekly_summary_format TEXT NOT NULL DEFAULT 'email' CHECK (weekly_summary_format IN ('email', 'sms', 'both')),
  weekly_summary_day TEXT NOT NULL DEFAULT 'sunday' CHECK (weekly_summary_day IN ('sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday')),
  weekly_summary_time TIME NOT NULL DEFAULT '18:00',

  -- Immediate alert preferences
  alert_missed_calls_enabled BOOLEAN NOT NULL DEFAULT true,
  alert_missed_calls_threshold INTEGER NOT NULL DEFAULT 3,

  UNIQUE(account_id, line_id)
);

-- RLS: Account-based policies
ALTER TABLE ultaura_notification_preferences ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view notification preferences for their accounts"
  ON ultaura_notification_preferences FOR SELECT
  USING (can_access_ultaura_account(account_id));

CREATE POLICY "Users can insert notification preferences for their accounts"
  ON ultaura_notification_preferences FOR INSERT
  WITH CHECK (can_access_ultaura_account(account_id));

CREATE POLICY "Users can update notification preferences for their accounts"
  ON ultaura_notification_preferences FOR UPDATE
  USING (can_access_ultaura_account(account_id));

CREATE POLICY "Users can delete notification preferences for their accounts"
  ON ultaura_notification_preferences FOR DELETE
  USING (can_access_ultaura_account(account_id));
```

## API Endpoints & Server Actions

### New Server Actions (`/src/lib/ultaura/insights.ts`)

```typescript
// Get insights for a specific line
export async function getLineInsights(lineId: string, options?: {
  startDate?: Date;
  endDate?: Date;
  limit?: number;
}): Promise<CallInsight[]>

// Get current baseline for a line
export async function getLineBaseline(lineId: string): Promise<LineBaseline | null>

// Get weekly summary for a specific week
export async function getWeeklySummary(lineId: string, weekStartDate: Date): Promise<WeeklySummary | null>

// Get aggregated insights for dashboard display
export async function getInsightsDashboard(lineId: string): Promise<InsightsDashboard>

// Update notification preferences
export async function updateNotificationPreferences(
  accountId: string,
  lineId: string,
  preferences: Partial<NotificationPreferences>
): Promise<void>

// Update insight privacy settings
export async function updateInsightPrivacy(
  lineId: string,
  settings: Partial<InsightPrivacy>
): Promise<void>

// Toggle pause mode
export async function setPauseMode(lineId: string, enabled: boolean, reason?: string): Promise<void>
```

### New Next.js API Endpoints (Email Delivery)

Following the existing pattern where telephony calls Next.js for email delivery:

```
POST /api/telephony/weekly-summary  - Receives WeeklySummaryData, renders template, sends email
POST /api/telephony/missed-calls    - Receives alert data, sends missed-call alert email
```

**Authentication**: `X-Webhook-Secret` header (timing-safe comparison against `ULTAURA_INTERNAL_API_SECRET`)

**Pattern**: Telephony generates data -> POST to Next.js -> Next.js renders email template -> sendEmail()

**Missed Calls Alert Payload**:
```typescript
interface MissedCallsAlertPayload {
  lineId: string;
  accountId: string;
  lineName: string;
  consecutiveMissedCount: number;
  lastAttemptAt: string; // ISO timestamp
  dashboardUrl: string;
  settingsUrl: string;
}
```

## Dashboard UI

### New Route: `/dashboard/(app)/insights/`

**Files to create**:
- `/src/app/dashboard/(app)/insights/page.tsx` - Main insights page
- `/src/app/dashboard/(app)/insights/InsightsPageClient.tsx` - Client component
- `/src/app/dashboard/(app)/insights/components/InsightsSummary.tsx` - Weekly summary card
- `/src/app/dashboard/(app)/insights/components/MoodTrend.tsx` - Mood visualization
- `/src/app/dashboard/(app)/insights/components/TopicsChart.tsx` - Topic distribution
- `/src/app/dashboard/(app)/insights/components/ConcernsList.tsx` - Active concerns
- `/src/app/dashboard/(app)/insights/components/CallMetrics.tsx` - Call statistics

### Insights Dashboard Layout

```
+-------------------------------------------------------------+
| [Line Selector Dropdown]                     [Date Range]   |
+-------------------------------------------------------------+
|                                                             |
|  +----------------------+  +------------------------------+ |
|  |   THIS WEEK SUMMARY  |  |        CALL ACTIVITY         | |
|  |                      |  |                              | |
|  |  Calls: 5/6 (+1)     |  |  [Simple bar chart showing   | |
|  |  Duration: 12m avg   |  |   calls per day last 30d]    | |
|  |  Mood: mostly neutral|  |                              | |
|  |                      |  |                              | |
|  +----------------------+  +------------------------------+ |
|                                                             |
|  +----------------------+  +------------------------------+ |
|  |   ENGAGEMENT TREND   |  |         MOOD TREND           | |
|  |                      |  |                              | |
|  |  [Only if notable]   |  |  [Color-coded dots showing   | |
|  |  "Down 2.6 from      |  |   mood per call over time]   | |
|  |   typical"           |  |                              | |
|  |                      |  |  o positive o neutral o low  | |
|  +----------------------+  +------------------------------+ |
|                                                             |
|  +---------------------------------------------------------+ |
|  |                    TOPICS THIS WEEK                     | |
|  |                                                         | |
|  |  [Family] [Memories] [Daily Life] [Entertainment] [Plans]| |
|  |                                                         | |
|  +---------------------------------------------------------+ |
|                                                             |
|  +---------------------------------------------------------+ |
|  |                   WELLBEING NOTES                       | |
|  |                                                         | |
|  |  [New] sleep trouble (moderate)                         | |
|  |  [Recurring] loneliness (mild)                          | |
|  |  [Resolved] anxiety (was moderate)                      | |
|  |                                                         | |
|  +---------------------------------------------------------+ |
|                                                             |
|  +---------------------------------------------------------+ |
|  |                    CALL HISTORY                         | |
|  |                                                         | |
|  |  [Enhanced CallActivityList with mood indicators]        | |
|  |                                                         | |
|  +---------------------------------------------------------+ |
+-------------------------------------------------------------+
```

**Call activity chart scope**: Include all call types (scheduled + reminder + inbound), with visual distinction by type/direction.

**Insights disabled banner**: Show a read-only banner when insights are disabled for the line; include a link to Line Settings to re-enable; keep historical data visible.

**Call history mood indicator**: 8x8 dot to the right of the status badge; show only for calls with insights where `mood_overall` is positive (`bg-success`) or low (`bg-destructive`); no dot for neutral or missing insights (including <3 min). Add tooltip text "Mood: Positive" / "Mood: Low".

### Settings Integration

Add to line settings page (`/src/app/dashboard/(app)/lines/[lineId]/settings/`):

**New section: "Insights & Privacy"**
- Toggle: Enable/disable insights for this line
- Topic privacy: Multi-select for private topics
- Pause mode: Toggle with optional reason field

**New section: "Weekly Summary"**
- Toggle: Enable/disable weekly summary
- Format: Email only (SMS hidden in MVP)
- Day: Dropdown (Sunday default)
- Time: Time picker (6pm default)

**Scope**: Line-specific controls only; no account-level defaults or inherited indicators

**Add Line Modal (Step 2 info callout)**:
Place after the AI/not-medical checkboxes in Step 2 (Preferences & Disclosures).
```
Info: About Call Insights

After each call, we'll capture a brief summary of topics discussed
and overall mood -- but never transcripts or quotes. You can disable
insights anytime in Line Settings.
```

## Scheduled Jobs

### 1. Weekly Summary Generator

**Frequency**: Hourly at :00 (checks which lines are due within the hour)

**Location**: `/telephony/src/scheduler/weekly-summary-scheduler.ts` (SEPARATE from call-scheduler)

**Why separate**:
- Call scheduler runs every 30 seconds; weekly summary runs hourly
- Different concerns: call initiation vs. aggregation + email
- If call scheduler hangs, weekly summaries shouldn't be blocked

**Logic**:
```typescript
async function generateWeeklySummaries() {
  // Run hourly, check each line's preferred day/time in their timezone
  const lines = await getLinesForWeeklySummary();

  for (const line of lines) {
    const lineTime = DateTime.now().setZone(line.timezone);
    const preferredHour = parseInt(line.weekly_summary_time.split(':')[0]);
    const preferredWeekday = mapWeekday(line.weekly_summary_day); // sunday=7 ... saturday=6

    if (lineTime.weekday !== preferredWeekday) continue;
    if (!isWithinWindow(lineTime.hour, preferredHour, 1)) continue;
    if (!line.notificationPrefs.weekly_summary_enabled) continue;
    if (!line.insightsEnabled) continue;

    // Dedup: only send once per week per line
    const weekStart = getWeekStart(lineTime, line.weekly_summary_day); // aligns with summary window
    if (line.last_weekly_summary_at && line.last_weekly_summary_at >= weekStart) {
      continue;
    }

    // Generate summary
    const summary = await aggregateWeeklyInsights(line.id);
    await storeWeeklySummary(line.id, summary);

    // POST to Next.js for email delivery
    const response = await fetch(`${NEXT_PUBLIC_SITE_URL}/api/telephony/weekly-summary`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Webhook-Secret': ULTAURA_INTERNAL_API_SECRET,
      },
      body: JSON.stringify(summary),
    });
    if (response.ok) {
      await markWeeklySummarySent(line.id, lineTime.toISO());
    }
  }
}
```

**Idempotency**: Use `ultaura_lines.last_weekly_summary_at` to prevent double-sends per week (set only after successful email send); `UNIQUE(line_id, week_start_date)` is a secondary backstop

### 2. Missed Call Alert Checker

**Frequency**: After each scheduled call attempt

**Location**: Extend existing call-scheduler

**Logic**:
```typescript
async function checkMissedCallAlert(lineId: string, wasAnswered: boolean) {
  if (wasAnswered) {
    await resetConsecutiveMissedCalls(lineId);
    return;
  }

  const newCount = await incrementConsecutiveMissedCalls(lineId);
  const { enabled, threshold } = await getMissedCallSettings(lineId); // includes alert_missed_calls_enabled

  const { insightsEnabled, missedAlertSentAt } = await getInsightsAlertState(lineId);

  if (enabled && newCount >= threshold && !missedAlertSentAt) {
    const isPaused = await isInsightsPaused(lineId);
    if (!isPaused && insightsEnabled) {
      await sendMissedCallAlert(lineId, newCount);
      await markMissedAlertSent(lineId);
    }
  }
}
```

## Email Templates

### Weekly Summary Email

**Location**: `/src/lib/emails/weekly-summary.tsx` (React Email)

```html
<!DOCTYPE html>
<html>
<head>
  <style>
    /* Email-safe CSS */
    .container { max-width: 600px; margin: 0 auto; font-family: Arial, sans-serif; }
    .header { background: #4A90A4; color: white; padding: 20px; text-align: center; }
    .section { padding: 20px; border-bottom: 1px solid #eee; }
    .metric { display: inline-block; margin-right: 20px; }
    .metric-value { font-size: 24px; font-weight: bold; }
    .metric-label { font-size: 12px; color: #666; }
    .topic-tag { display: inline-block; background: #e3f2fd; padding: 4px 12px; border-radius: 16px; margin: 4px; }
    .concern { padding: 8px 0; }
    .concern-new { color: #f57c00; }
    .concern-recurring { color: #1976d2; }
    .concern-resolved { color: #388e3c; }
    .footer { padding: 20px; font-size: 12px; color: #999; text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Weekly Check-in Summary</h1>
      <p>{{lineName}} - Week of {{weekStartDate}} to {{weekEndDate}}</p>
    </div>

    {{#if isPaused}}
    <div class="section" style="background: #f5f5f5;">
      <p>{{pausedNote}}</p>
    </div>
    {{/if}}

    <div class="section">
      <h2>Call Activity</h2>
      <div class="metric">
        <div class="metric-value">{{answeredCalls}}/{{scheduledCalls}}</div>
        <div class="metric-label">Calls Answered {{answerTrendLabel}}</div>
      </div>
      <div class="metric">
        <div class="metric-value">{{avgDurationMinutes}}m</div>
        <div class="metric-label">Avg Duration {{durationTrendLabel}}</div>
      </div>
      {{#if showMissedCallsWarning}}
      <div class="metric">
        <div class="metric-value">{{missedCalls}}</div>
        <div class="metric-label">Missed Calls</div>
      </div>
      {{/if}}
    </div>

    {{#if engagementNote}}
    <div class="section">
      <h2>Engagement</h2>
      <p>{{engagementNote}}</p>
    </div>
    {{/if}}

    <div class="section">
      <h2>Mood This Week</h2>
      <p>{{moodSummary}}</p>
    </div>

    <div class="section">
      <h2>Topics Discussed</h2>
      {{#each topTopics}}
      <span class="topic-tag">{{this.label}}</span>
      {{/each}}
    </div>

    {{#if concerns.length}}
    <div class="section">
      <h2>Wellbeing Notes</h2>
      {{#each concerns}}
      <div class="concern concern-{{this.novelty}}">
        {{this.novelty}}: {{this.label}} ({{this.severity}})
      </div>
      {{/each}}
    </div>
    {{/if}}

    {{#if needsFollowUp}}
    <div class="section" style="background: #fff3e0;">
      <h2>Follow-up Suggested</h2>
      <p>Based on this week's patterns, consider checking in about: {{followUpReasons}}</p>
    </div>
    {{/if}}

    <div class="footer">
      <p>These insights are generated by AI and are not medical or clinical advice.</p>
      <p>For emergencies, contact local emergency services.</p>
      <p><a href="{{settingsUrl}}">Manage notification preferences</a></p>
    </div>
  </div>
</body>
</html>
```

**Template notes**:
- Derive `answerTrendLabel` at render time from `answerTrend` + `answerTrendValue` (e.g., "(+1 vs last week)"); omit when null.
- Derive `durationTrendLabel` at render time from `durationTrend` + `durationTrendValue` (e.g., "(down 2m vs last week)"); omit when null.
- Render the concerns section only when `concerns.length > 0`.
- Render the missed calls metric only when `showMissedCallsWarning` is true.
- When `isPaused` is true, set `pausedNote` to a user-facing string (default: "Calls are currently paused for this line.").
- Title-case `novelty` when displayed (e.g., "New", "Recurring", "Resolved").
- Join `followUpReasons` into a human-readable string (e.g., "sleep trouble, missed routine").

### Missed Calls Alert Email

**Location**: `/src/lib/emails/missed-calls-alert.tsx` (React Email)

Subject: `Missed check-ins for [DisplayName]`

Body content (HTML):
```
Hi,

[DisplayName] has missed [X] consecutive scheduled calls from Ultaura.

This could mean:
- Phone is off or out of reach
- They're busy or away
- Line settings may need adjustment

What you can do:
- Give them a call to check in
- Review call schedule in your dashboard

[View Dashboard Button]

If you'd like to pause calls temporarily, you can do so in Line Settings.

-- Ultaura
```

**Template notes**:
- The "View Dashboard" button links to `dashboardUrl`.
- Use `settingsUrl` for the line settings link if included.

## Weekly Summary Structured Data Schema

When telephony calls Next.js to send a summary, it provides this JSON structure:

```typescript
interface WeeklySummaryData {
  // Identifiers
  lineId: string;
  lineName: string;
  accountId: string;
  billingEmail: string;
  weekStartDate: string; // YYYY-MM-DD in line's timezone
  weekEndDate: string;
  timezone: string;

  // Call activity
  scheduledCalls: number; // total scheduled session attempts (schedule:*)
  answeredCalls: number; // answered scheduled sessions only
  missedCalls: number; // scheduledCalls - answeredCalls
  showMissedCallsWarning: boolean; // true when answer_rate drop >=20pp vs baseline and missedCalls >=2
  answerTrend: 'up' | 'down' | 'stable' | null; // compared to prior week
  answerTrendValue: number | null; // answeredCalls - priorWeekAnsweredCalls (null if no prior week data)
  avgDurationMinutes: number; // average across all answered calls (scheduled + reminder + inbound)
  durationTrend: 'up' | 'down' | 'stable' | null; // compared to prior week
  durationTrendValue: number | null; // avgDurationMinutes - priorWeekAvgDurationMinutes (null if no prior week data)

  // Engagement (null if no insights this week)
  engagementNote: string | null; // e.g., "down 2.6 points from typical"

  // Mood
  moodSummary: string | null; // e.g., "mostly positive", "mixed week"
  moodDistribution: {
    positive: number; // count
    neutral: number;
    low: number;
  } | null;

  // Topics & concerns
  topTopics: Array<{
    code: string;
    label: string;
    weight: number;
  }>; // up to 5, with private topics filtered out

  concerns: Array<{
    code: string;
    label: string;
    severity: 'mild' | 'moderate' | 'significant';
    novelty: 'new' | 'recurring' | 'resolved';
  }>;

  // Flags
  needsFollowUp: boolean;
  followUpReasons: string[]; // deduped union across the week (human-readable labels)
  isPaused: boolean;
  pausedNote: string | null; // set when isPaused (default: "Calls are currently paused for this line.")

  // Links
  dashboardUrl: string;
  settingsUrl: string;
}
```

## Lazy Notification Preferences Pattern

```typescript
async function getNotificationPreferences(
  accountId: string,
  lineId: string
): Promise<NotificationPreferences> {
  const supabase = getSupabaseClient();

  const { data: linePrefs } = await supabase
    .from('ultaura_notification_preferences')
    .select('*')
    .eq('account_id', accountId)
    .eq('line_id', lineId)
    .single();

  if (linePrefs) return linePrefs;

  // Create line-specific defaults if missing
  const { data: newLinePrefs } = await supabase
    .from('ultaura_notification_preferences')
    .insert({
      account_id: accountId,
      line_id: lineId,
      weekly_summary_enabled: true,
      weekly_summary_format: 'email',
      weekly_summary_day: 'sunday',
      weekly_summary_time: '18:00',
      alert_missed_calls_enabled: true,
      alert_missed_calls_threshold: 3,
    })
    .select()
    .single();

  return newLinePrefs;
}
```

## Implementation Clarifications (Part 2)

This section documents detailed implementation decisions made during spec review.

### Weekly Summary & Notifications

| Decision | Details |
|----------|---------|
| **Pause mode behavior** | Weekly summaries still sent with "paused" note; missed-call alerts are suppressed |
| **Notification recipients** | Billing email only (account's `billing_email` field) |
| **SMS in notification prefs UI** | Hide SMS option for MVP - only show email toggle; ignore sms/both at send time |
| **Summary generation flow** | Telephony generates + encrypts + stores summary; calls Next.js API just to send email |
| **Weekly summary dedup** | Track `ultaura_lines.last_weekly_summary_at` and send at most once per line per week; set only after successful email send |
| **Delivery timing** | 60-minute window is "on time"; if missed, catch up later same day |
| **Alert recipient** | Billing email only (same as summaries) |
| **Summary API format** | Structured JSON data; Next.js renders email template |
| **Weekly summary call counts** | Use actual call sessions (schedule:*) for answered/total counts, not expected schedule occurrences |
| **Answer trend (weekly summary)** | `answerTrendValue = answeredCalls - priorWeekAnsweredCalls`; `answerTrend` is `up/down/stable` based on the sign; null if no prior week data |
| **Duration trend (weekly summary)** | `durationTrendValue = avgDurationMinutes - priorWeekAvgDurationMinutes`; `durationTrend` is `up/down/stable` based on the sign; null if no prior week data |
| **Average duration scope** | Compute `avgDurationMinutes` from all answered calls (scheduled + reminder + inbound) |
| **Missed calls warning** | Set `showMissedCallsWarning` when answer_rate drop >=20pp vs baseline AND missedCalls >=2; show the metric only when true |
| **Missed call alerts enabled** | Only send missed-call alerts when `alert_missed_calls_enabled` is true |
| **`week_start_date` format** | Line's local date (user's timezone), not UTC |
| **Week range when not Sunday** | 7 days ending day before send (e.g., Wednesday send = previous Wed -> this Tue) |

### Dashboard UI

| Decision | Details |
|----------|---------|
| **Date range UI** | Static "Last 30 days" label only - no picker, no interactivity |
| **Default line selection** | Prioritize active status first; only fall back to paused/disabled if no active lines exist |
| **Insights disabled UI** | Show historical data with a disabled banner; include a link to Line Settings to re-enable (do not hide) |
| **Call history mood indicator** | 8x8 dot to the right of status badge; show only for positive (`bg-success`) and low (`bg-destructive`) moods; no dot for neutral or missing insights (including <3 min); tooltip "Mood: Positive" / "Mood: Low" |

## Acceptance Criteria (Part 2)
- Insights dashboard route and components render with the specified layout, call activity chart scope, and mood indicators.
- Line settings include "Insights & Privacy" and "Weekly Summary" controls; AddLineModal callout matches the provided copy and SMS remains hidden.
- Weekly summaries generate on schedule, deduplicate per week, and send email-only notifications via the Next.js API using WeeklySummaryData.
- Missed-call alert emails send once per streak at the configured threshold and are suppressed during pause mode.
- Notification preferences are line-specific, created lazily on first read, and stored per schema.

## Testing and Verification Checklist (Part 2)
- Weekly summary aggregation across multiple calls and correct trend calculations.
- Email delivery rendering for weekly summary and missed-call alert templates.
- Missed-call alert threshold logic and pause-mode suppression.
- Dashboard displays aggregated data, topic tags, concern states, and follow-up flags correctly.
- Privacy settings hide private topics in UI while keeping calculations intact.
- Mobile dashboard responsiveness and loading/error states.

## Shared Definitions (Appendix)

### Overview

**Problem**: Dashboard shows call activity (duration, status) but no meaningful "signals". Families don't see value week-to-week. We're missing our differentiation vs competitors like Meela.

**Solution**: Build an insights system that extracts and stores only **canonical tags, scores, trends, and metadata** - no quotes, no paraphrased sentences, no raw transcripts. Everything is **baseline-aware** so families see *what changed*, not noisy "AI vibes."

**Impact**: Medium/High
**Likelihood of Success**: High
**Launch Approach**: Full feature build before launch

### Design Principles

1. Actionable > Interesting: Every signal must answer "Should I check in?" and "About what?"
2. Trend + Change Detection: Show deviation from baseline rather than absolute values.
3. No Content Storage: Store only scores, tag IDs, severity, overall confidence, and call metadata. No verbatim text, no "summary paragraph."
4. Consent Controls: Privacy controls via settings AND voice commands during calls.
5. Language Agnostic: Works for all languages Grok supports.

### Target Audience

- Primary viewers: Both family members (payers) AND seniors see the same insights view.
- Access point: New dedicated "Insights" tab in dashboard.
- History depth: Last 30 days with weekly comparison.

### Core Metrics ("The Core 5")

#### 1. Answered / Missed + Call Duration

**Purpose**: Fastest proxy for isolation, routine disruption, availability.

**Stored fields**:
- `answered` (boolean)
- `duration_seconds` (integer)
- `direction` (enum: inbound/outbound)
- `end_reason` (enum: hangup, no_answer, busy, trial_cap, minutes_cap, error)

**Display**: Show trends vs baseline (e.g., "Calls answered: 5/6 (+1 from last week)")

**Minimum call threshold**: Insights are NOT generated for calls under 3 minutes

#### 2. Engagement Score (1-10)

**Definition**: Model-provided 1-10 score only (no objective blending for MVP).

**Stored fields**:
- `engagement_score` (decimal 1-10)

**Formatting**: Store as decimal; round for display

**Display**: Change-focused only
- Only surface when score deviates significantly downward from baseline
- Example: "Engagement: down 2.6 points from typical"
- Never show "higher than typical"

**Alert threshold**: 2.5 points below baseline triggers concern (downward only)

#### 3. Mood (3-state + intensity)

**Output**:
- `mood_overall`: enum (`positive` | `neutral` | `low`)
- `mood_intensity`: integer 0-3 (how strongly expressed)

**UI Label**: "Mood" (not clinical, but clear)
- Display as: "Mood: positive", "Mood: neutral", "Mood: low"
- Weekly summary label can be "Mixed week" if the week includes both positive and low calls

**Display**: Change-focused - only highlight when pattern shifts (3+ low calls in week with baseline <= 1)

#### 4. Social Need / Loneliness Indicator (0-3)

**Output**:
- `social_need_level`: integer 0-3

**Trigger signals** (detected but not stored as quotes):
- Asked for more calls
- Expressed feeling alone
- Seeking reassurance
- Limited social mentions

**Display**: Trend-only (derived from `follow_up_reasons` contains `wants_more_contact`)
- Only surface if `wants_more_contact` appears in 3 consecutive weeks and baseline had 0 occurrences
- Baseline window for this trend is the 14 days immediately BEFORE the 3-week streak (total lookback = 5 weeks)
- Example: "Social connection: may benefit from extra contact"
- Do NOT show if level is normal/stable

#### 5. Needs Follow-up Flag

**Output**:
- `needs_follow_up`: boolean
- `follow_up_reasons`: array of reason codes (strict enum - see below)

**Allowed reason codes**:
- All concern codes: `loneliness`, `sadness`, `anxiety`, `sleep`, `pain`, `fatigue`, `appetite`
- Additional codes: `wants_more_contact`, `missed_routine`

**Purpose**: Single caregiver-friendly output answering "Should I follow up?"

**Display**: Prominent when true, hidden when false

### Topic Tracking

#### Topic Taxonomy (10 Categories - Engagement-Focused)

| Code | Label | Description |
|------|-------|-------------|
| `family` | Family | Discussions about family members, relationships |
| `friends` | Friends | Social connections, friendships |
| `activities` | Activities | Things they're doing, physical activities |
| `interests` | Interests | Hobbies, passions, ongoing interests |
| `memories` | Stories & Memories | Past events, life stories, reminiscing |
| `plans` | Plans & Future | Upcoming events, things to look forward to |
| `daily_life` | Daily Life | Routine, meals, household, schedules |
| `entertainment` | Entertainment | TV, movies, books, music, games |
| `feelings` | Feelings | Emotional expression, how they're feeling |
| `requests` | Requests | Things they need help with, asks |

#### Storage per call:
```json
{
  "topics": [
    {"code": "family", "weight": 0.6},
    {"code": "memories", "weight": 0.3},
    {"code": "daily_life", "weight": 0.1}
  ]
}
```

#### Display:
- Per call: Top 3 topics
- Weekly summary: Top 5 topics for the week
- Shown as simple tags/chips in UI

#### Privacy Controls:
- Topics can be marked private during calls via `mark_topic_private` (persists to line settings)
- `log_call_insights.private_topics` hides topics for the current call only (does not persist)
- Topics can be configured as private in line settings
- Private topics are stored but NOT shown to any viewer in insights

### Concern Tracking

#### Concern Taxonomy (7 Categories - Wellbeing-Focused)

| Code | Label | Severity Range | Description |
|------|-------|----------------|-------------|
| `loneliness` | Loneliness | 1-3 | Expressed isolation, wanting more contact |
| `sadness` | Sadness | 1-3 | Grief, low mood, tearfulness |
| `anxiety` | Anxiety | 1-3 | Worry, stress, nervousness |
| `sleep` | Sleep Trouble | 1-3 | Sleep quality, insomnia, fatigue from sleep |
| `pain` | Pain/Discomfort | 1-3 | Physical discomfort (self-reported, non-diagnostic) |
| `fatigue` | Fatigue | 1-3 | Low energy, tiredness |
| `appetite` | Appetite | 1-3 | Eating concerns, appetite changes |

#### Storage per call:
```json
{
  "concerns": [
    {
      "code": "loneliness",
      "severity": 2,
      "confidence": 0.8,
      "is_novel": false
    }
  ]
}
```

#### Novelty Tracking:
- Per-call: store `is_novel` boolean (true = new, false = recurring)
- Weekly summary: mark "resolved" when a concern appears in the baseline window but not in the current week

#### Display:
- Show ALL detected concerns by default (no opt-in required)
- Format: Category + Severity + Trend
- Examples:
  - "New this week: sleep trouble (moderate)"
  - "Recurring: loneliness (mild)"
  - "Resolved: anxiety (was moderate last week -> not present)"

#### Important:
- No quotes or paraphrased sentences
- Label as self-reported observations, NOT clinical assessments

### Safety System Integration

#### Separate Systems

The existing safety system (low/medium/high tiers) handles emergencies:
- Suicide ideation, self-harm, abuse, immediate danger
- Triggers trusted contact notifications
- Remains unchanged

The new concerns system handles non-urgent wellbeing patterns:
- Loneliness, sadness, anxiety, sleep, etc.
- Surfaces in weekly insights
- Does NOT trigger emergency alerts

#### No Overlap
- Safety events continue to work as they do today
- Concerns are separate and lower-priority
- If something is urgent, safety system handles it; insights system does not escalate

### NOT Tracking (Explicitly Excluded)

#### Conversation Clarity / Confusion

**Decision**: Do NOT implement clarity/confusion/disorientation tracking.

**Reason**: Too risky - potential for:
- Misuse by families
- Liability issues
- False positives causing alarm
- Not appropriate for non-clinical AI system

### Alerting Rules

#### Tier 1: Weekly Summary Only (No Immediate Alert)

- Engagement down >= 2.5 from baseline for 2+ calls (downward only)
- Mood pattern shift: 3+ calls in the week with mood=low and baseline window had <= 1
- New concern at severity 2 or higher
- Missed calls increased from typical pattern (answer_rate drop >= 20 percentage points vs baseline AND at least 2 missed scheduled calls)

#### Tier 2: Immediate Notification

**Triggers**:
1. Safety events (existing system - unchanged)
2. 3+ consecutive scheduled calls missed (send once per streak; reset on answered scheduled outbound)

**Notification format**: Email only for MVP (SMS not implemented)

**Smart gap detection**:
- Only alert if schedule was expected but calls didn't happen
- Respect "pause" mode when family marks senior as away

### Pause Mode

#### Purpose
Allow families to suppress alerts/insights when senior is traveling, hospitalized, visiting family, etc.

#### Implementation

**Dashboard toggle**: Simple on/off in line settings
- No end date required (simple implementation)
- Manual toggle off when senior returns

**Voice activation**:
- Senior can say "I'll be away next week" or similar
- System auto-enables pause mode
- Grok tool: `set_pause_mode`

**Effects when paused**:
- Scheduled calls still happen (unless schedule is paused separately)
- Insights still generated and stored
- Alerts are suppressed
- Weekly summary notes "paused" status

### Baseline Calculation

#### Baseline Window (14 days, excluding current week)

For trend comparisons, the baseline uses the 14 days immediately preceding the current 7-day summary window (no overlap).

```
|-------- baseline (days -21 to -8) --------|------- current week (days -7 to 0) -------|
```

For each metric (engagement, mood distribution, typical duration, typical call count):

```sql
-- Example: engagement baseline
SELECT AVG(engagement_score)
FROM ultaura_call_insights
WHERE line_id = $1
  AND created_at >= $baseline_start
  AND created_at < $baseline_end
  AND engagement_score IS NOT NULL
```

Baseline window definitions (line-local dates):

```
week_end = start of today
week_start = week_end - 7 days
baseline_end = week_start
baseline_start = baseline_end - 14 days
```

**Note**: Social-need trend uses a separate 5-week lookback: 14-day baseline immediately before the 3-week streak window.

#### Storage

**Table**: `ultaura_line_baselines`

| Column | Type | Description |
|--------|------|-------------|
| `line_id` | UUID | FK to ultaura_lines |
| `updated_at` | timestamptz | Last calculation time |
| `avg_engagement` | decimal | Rolling average engagement |
| `avg_duration_seconds` | integer | Rolling average call duration |
| `calls_per_week` | decimal | Rolling average calls/week |
| `mood_distribution` | jsonb | % positive/neutral/low |
| `answer_rate` | decimal | % of scheduled calls answered |

#### Update Frequency
- Nightly batch job (MVP): run once daily at 10:00 UTC
- Include ALL answered call types (scheduled + reminder + inbound) for engagement and mood baselines; social-need trend uses the same call set on demand
- Answer rate remains scheduled-only (see calculation below)

### Decrypted Insights JSON Schema (Shared Types)

```typescript
// Strict type definitions matching Zod schema
type TopicCode = 'family' | 'friends' | 'activities' | 'interests' | 'memories' | 'plans' | 'daily_life' | 'entertainment' | 'feelings' | 'requests';
type ConcernCode = 'loneliness' | 'sadness' | 'anxiety' | 'sleep' | 'pain' | 'fatigue' | 'appetite';
type FollowUpReasonCode = ConcernCode | 'wants_more_contact' | 'missed_routine';

interface CallInsights {
  // Core metrics
  mood_overall: 'positive' | 'neutral' | 'low';
  mood_intensity: number; // 0-3
  engagement_score: number; // 1-10 (model-provided, no blending for MVP)
  social_need_level: number; // 0-3

  // Topics (strict enum codes)
  topics: Array<{
    code: TopicCode;
    weight: number; // 0-1
  }>;

  // Private topics (stored but not shown to ANY viewer)
  private_topics: TopicCode[];

  // Concerns (strict enum codes)
  concerns: Array<{
    code: ConcernCode;
    severity: number; // 1-3 (1=mild, 2=moderate, 3=significant)
    confidence: number; // 0-1
    is_novel: boolean; // true=new, false=recurring
  }>;

  // Follow-up (strict enum codes)
  needs_follow_up: boolean;
  follow_up_reasons: FollowUpReasonCode[];

  // Meta
  confidence_overall: number; // 0-1 (if <0.5, treat insights as provisional)
}
```

### Answered Detection Logic

```typescript
function isCallAnswered(session: CallSession): boolean {
  // Human confirmed by AMD
  if (session.answered_by === 'human') return true;
  // AMD uncertain but optimistic
  if (session.answered_by === 'unknown') return true;
  // AMD disabled but call connected
  if (session.answered_by === null && session.seconds_connected > 0) return true;
  // All other cases (machine, fax, no answer)
  return false;
}

function shouldResetMissedCounter(session: CallSession): boolean {
  return (
    isCallAnswered(session) &&
    session.direction === 'outbound' &&
    session.scheduler_idempotency_key?.startsWith('schedule:')
  );
}

function shouldUpdateLastAnsweredCallAt(session: CallSession): boolean {
  // Any answered call updates this (inbound, reminder, scheduled)
  return isCallAnswered(session);
}

function shouldSendMissedAlert(line: LineRow, newCount: number, threshold: number): boolean {
  return newCount >= threshold && !line.missed_alert_sent_at;
}
```

### Encryption Implementation

#### Reuse Existing Key Infrastructure

Use the same DEK/KEK pattern as `ultaura_memories`:

```typescript
// From existing memory encryption
import { getAccountDEK, encryptField, decryptField } from '../services/memory-crypto';

async function encryptInsights(
  accountId: string,
  insights: CallInsights
): Promise<EncryptedInsights> {
  const dek = await getAccountDEK(accountId);
  const plaintext = JSON.stringify(insights);

  return encryptField(dek, plaintext, {
    aad: `insights:${accountId}`
  });
}

async function decryptInsights(
  accountId: string,
  encrypted: EncryptedInsights
): Promise<CallInsights> {
  const dek = await getAccountDEK(accountId);

  const plaintext = await decryptField(dek, encrypted, {
    aad: `insights:${accountId}`
  });

  return JSON.parse(plaintext);
}
```

### Encryption AAD Structure

```typescript
// For call insights
function buildInsightsAAD(
  accountId: string,
  lineId: string,
  callSessionId: string
): Buffer {
  return Buffer.from(JSON.stringify({
    account_id: accountId,
    line_id: lineId,
    call_session_id: callSessionId,
    type: 'call_insight'
  }), 'utf8');
}

// For weekly summaries
function buildSummaryAAD(
  accountId: string,
  lineId: string,
  weekStartDate: string
): Buffer {
  return Buffer.from(JSON.stringify({
    account_id: accountId,
    line_id: lineId,
    week_start: weekStartDate,
    type: 'weekly_summary'
  }), 'utf8');
}
```

## Shared Context (Appendix)

### Assumptions

1. Grok reliably calls the `log_call_insights` tool at end of conversations
2. Existing encryption key infrastructure is working correctly
3. Email delivery infrastructure (Nodemailer) is operational
4. Users have valid email addresses in their accounts
5. Recharts library (already installed) is sufficient for visualizations
6. 14-day baseline is sufficient for meaningful deviation detection
7. Supabase handles the additional query load from insights tables

### Open Questions (Resolved)

| Question | Resolution |
|----------|------------|
| Who sees insights? | Both family and seniors, same view |
| When generated? | Real-time, after each call |
| Store transcripts? | No - scores/codes only |
| Clarity tracking? | NO - removed for liability |
| Export data? | No exports - in-app only |
| Language support? | All languages Grok supports |
| Pause mode? | Simple toggle + voice activation |
| Alert threshold? | 2.5 points for engagement, 3 missed calls |

### Success Metrics

1. **Adoption**: % of accounts viewing insights tab weekly
2. **Engagement**: Average time spent on insights page
3. **Value perception**: Reduction in churn for accounts using insights
4. **Alert accuracy**: False positive rate for missed call alerts
5. **Email engagement**: Open rate for weekly summaries
6. **Concern detection**: Rate of concern detection vs baseline
7. **Differentiation**: Competitor comparison in user research

### Disclaimer Text

For weekly emails and any in-app displays:

> These insights are generated by AI based on conversation patterns and are not medical, clinical, or professional advice. Ultaura is not an emergency service. If you believe there is immediate danger, contact local emergency services (911 in the US).
